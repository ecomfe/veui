<template>
  <div class="veui-uploader" :ui="ui" ref="main">
    <div class="veui-uploader-button-container" v-if="type === 'file'">
      <label class="veui-button veui-uploader-input-label"
        :class="{'veui-uploader-input-label-disabled': realDisabled || (fileList.length >= maxCount)
         || (requestMode === 'iframe' && isSubmiting)}"
        @click="replacingFile = null" ref="label">
        <slot name="button-label"><icon class="veui-uploader-input-label-icon"
          :name="icons.upload"></icon>选择文件</slot>
        <input :id="inputId" hidden type="file" ref="input"
          @change="onChange"
          :name="realName"
          :disabled="realDisabled || (fileList.length >= maxCount)
           || (requestMode === 'iframe' && isSubmiting)"
          :accept="accept"
          :multiple="(maxCount > 1 || maxCount === undefined) && !isReplacing"
          @click.stop>
      </label>
      <span class="veui-uploader-tip"><slot name="desc"></slot></span>
    </div>
    <ul :class="listClass">
      <li v-for="(file, index) in fileList" :key="index">
        <template v-if="(type === 'file' && file.status !== 'uploading')
          || type === 'image' && (!file.status || file.status === 'success')">
          <slot name="file" :file="file">
            <template v-if="type === 'file'">
              <icon :name="icons.file" class="veui-uploader-list-icon"></icon>
              <span class="veui-uploader-list-name"
                :class="{'veui-uploader-list-name-success': file.status === 'success',
                  'veui-uploader-list-name-failure': file.status === 'failure'
                }"
                :title="file.name">{{file.name}}</span>
              <span v-if="file.status === 'success'" class="veui-uploader-success"><slot name="success-label">上传成功！</slot></span>
              <span v-if="file.status === 'failure'" class="veui-uploader-failure"><slot name="failure-label">上传失败</slot></span>
              <veui-button v-if="file.status === 'failure'" ui="link" @click="retry(file)" :class="listClass + '-retry'"><icon :name="icons.redo"></icon>重试</veui-button>
              <veui-button ui="link remove" @click="removeFile(file)" :disabled="realDisabled"><icon :name="icons.clear"></icon></veui-button>
            </template>
            <template v-else>
              <img :src="file.src" :alt="file.alt || ''">
              <div v-if="!realDisabled" :class="listClass + '-mask'">
                <label :for="inputId"
                  class="veui-button"
                  :class="{'veui-uploader-input-label-disabled': realDisabled}"
                  ui="link"
                  @click.stop="replaceFile(file)">重新上传</label>
                <veui-button ui="link" @click="removeFile(file)" :disabled="realDisabled" :class="listClass + '-mask-remove'"><icon :name="icons.clear"></icon>移除</veui-button>
              </div>
            </template>
            <transition name="veui-uploader-fade">
              <div v-if="type === 'image' && file.status === 'success'"
                :class="listClass + '-success'"
                @click="updateFileList(file, {status: null})">
                <span class="veui-uploader-success"><slot name="success-label"><icon :name="icons.success"></icon>完成</slot></span>
              </div>
            </transition>
          </slot>
        </template>
        <template v-else-if="file.status === 'uploading'">
          <slot name="uploading" :file="file">
            <veui-uploader-progress :type="progress" :loaded="file.loaded" :total="file.total"
              :class="type === 'image' ? listClass + '-status' : ''"
              :convertSizeUnit="convertSizeUnit">
              <slot name="uploading-label">上传中...</slot>
            </veui-uploader-progress>
            <veui-button v-if="type === 'file'" ui="link remove"
              @click="cancelFile(file)"><icon :name="icons.clear"></icon></veui-button>
            <veui-button v-else ui="aux operation"
              @click="cancelFile(file)">取消</veui-button>
          </slot>
        </template>
        <template v-else-if="file.status === 'failure' && type === 'image'">
          <slot name="failure" :file="file">
            <div :class="listClass + '-status'">
              <span class="veui-uploader-failure"><slot name="failure-label">错误！</slot>{{file.failureReason}}</span>
            </div>
            <veui-button ui="aux operation" @click="retry(file)">重试</veui-button>
          </slot>
        </template>
      </li>
      <li v-if="type === 'image'" key="input"
        v-show="!maxCount || fileList.length < maxCount">
        <label class="veui-uploader-input-label-image"
          :class="{'veui-uploader-input-label-disabled': realDisabled || (requestMode === 'iframe' && isSubmiting)}"
          @click="replacingFile = null"
          ref="label"><input :id="inputId" hidden type="file" ref="input"
            @change="onChange"
            :name="realName"
            :disabled="realDisabled || (requestMode === 'iframe' && isSubmiting)"
            :accept="accept"
            :multiple="(maxCount > 1 || maxCount === undefined) && !isReplacing"
            @click.stop>
            <icon :name="icons.add"></icon>
        </label>
      </li>
    </ul>
    <span class="veui-uploader-tip" v-if="type === 'image'"><slot name="desc"></slot></span>
    <iframe v-if="requestMode === 'iframe' && isSubmiting" ref="iframe"
     :id="iframeId" :name="iframeId" class="veui-uploader-hide"></iframe>
    <form v-if="requestMode === 'iframe' && isSubmiting" ref="form" :action="queryURL" enctype="multipart/form-data"
      method="POST" :target="iframeId" class="veui-uploader-hide">
      <input v-for="(value, key) in payload" :name="key" :value="value">
      <input v-if="iframeMode === 'callback'" name="callback" :value="`parent.${callbackNamespace}['${callbackFuncName}']`">
    </form>
  </div>
</template>

<script>
import Button from './Button'
import Icon from './Icon'
import { cloneDeep, uniqueId, assign, isNumber, isArray } from 'lodash'
import { ui, input, icons } from '../mixins'
import config from '../managers/config'
import { stringifyQuery } from '../utils/helper'
import bytes from 'bytes'

config.defaults({
  'uploader.requestMode': 'xhr',
  'uploader.iframeMode': 'postmessage',
  'uploader.callbackNamespace': 'veuiUploadResult'
})

export default {
  name: 'veui-uploader',
  components: {
    Icon,
    'veui-button': Button,
    'veui-uploader-progress': getProgress()
  },
  mixins: [ui, input, icons],
  model: {
    event: 'change'
  },
  props: {
    value: {
      type: [Array, String]
    },
    type: {
      type: String,
      default: 'file'
    },
    action: {
      type: String,
      required: true
    },
    headers: {
      type: Object,
      default () {
        return config.get('uploader.headers')
      }
    },
    withCredentials: {
      type: Boolean,
      default: true
    },
    requestMode: {
      type: String,
      default () {
        return config.get('uploader.requestMode')
      }
    },
    iframeMode: {
      type: String,
      default () {
        return config.get('uploader.iframeMode')
      }
    },
    convertResponse: {
      type: Function,
      default () {
        return config.get('uploader.convertResponse')
      }
    },
    callbackNamespace: {
      type: String,
      default () {
        return config.get('uploader.callbackNamespace')
      }
    },
    extensions: {
      type: Object,
      default () {
        return {
          image: {
            'jpg': true, 'jpeg': true, 'gif': true, 'bmp': true, 'tif': true, 'tiff': true, 'png': true
          }
        }
      }
    },
    accept: String,
    ui: String,
    maxCount: Number,
    maxSize: [Number, String],
    payload: Object,
    progress: {
      type: String,
      default: 'text'
    },
    autoUpload: {
      type: Boolean,
      default: true
    }
  },
  data () {
    return {
      fileList: this.genFileList(this.value),
      canceled: false,
      // inputId用于图片里的重新上传的label的for
      inputId: uniqueId('veui-uploader-input'),
      iframeId: uniqueId('veui-uploader-iframe'),
      callbackFuncName: uniqueId('veuiUploaderCallback'),
      onMessage: null,
      replacingFile: null,
      currentSubmitingFile: null,
      isSubmiting: true
    }
  },
  watch: {
    value (val) {
      let currentSubmitingFileIndex = this.fileList.indexOf(this.currentSubmitingFile)
      this.fileList = this.genFileList(val)
      if (currentSubmitingFileIndex > -1) {
        this.currentSubmitingFile = this.fileList[currentSubmitingFileIndex]
      }
    }
  },
  computed: {
    listClass () {
      return `veui-uploader-list${this.type === 'image' ? '-image' : ''}`
    },
    latestFile () {
      return this.fileList[this.fileList.length - 1]
    },
    queryURL () {
      let queryString = stringifyQuery(assign(
        this.requestMode === 'iframe' && this.iframeMode === 'callback'
          ? {callback: `parent.${this.callbackNamespace}['${this.callbackFuncName}']`}
          : {},
        this.payload
      ))
      return `${this.action}${queryString ? '?' + queryString : ''}`
    },
    isReplacing () {
      return !!this.replacingFile
    }
  },
  mounted () {
    if (this.requestMode === 'xhr') return

    document.body.appendChild(this.$refs.iframe)
    document.body.appendChild(this.$refs.form)
    this.isSubmiting = false

    if (this.iframeMode === 'postmessage') {
      this.onMessage = event => {
        if (!event.source.frameElement || event.source.frameElement.id !== this.iframeId) return
        if (this.canceled) return
        // 支持action为绝对路径或相对路径，ie9里的location没有origin
        let actionOrigin = /^https?:\/\//.test(this.action)
          ? this.action.match(/^https?:\/\/[^/]*/)[0]
          : location.origin || (location.protocol + '//' + location.host)
        if (actionOrigin !== event.origin) return

        this.uploadCallback(this.parseData(event.data), this.currentSubmitingFile)
      }
      window.addEventListener('message', this.onMessage)
    } else if (this.iframeMode === 'callback') {
      if (!window[this.callbackNamespace]) {
        window[this.callbackNamespace] = {}
      }
      window[this.callbackNamespace][this.callbackFuncName] = data => {
        if (this.canceled) return
        this.uploadCallback(this.parseData(data), this.currentSubmitingFile)
      }
    }
  },
  beforeDestroy () {
    if (this.requestMode === 'xhr') return
    window.removeEventListener('message', this.onMessage)

    if (this.iframeMode === 'callback') {
      window[this.callbackNamespace][this.callbackFuncName] = null
    }
  },
  methods: {
    genFileList (value) {
      if (this.maxCount !== 1 && isArray(value)) {
        return cloneDeep(value)
      }
      return value ? [assign(this.fileList ? this.fileList[0] : {}, {
        src: value,
        name: value
      })] : []
    },
    onChange () {
      this.canceled = false

      let newFiles
      if (this.requestMode === 'xhr') {
        newFiles = [...this.$refs.input.files].filter(file => {
          return this.validateFile(file)
        })
      } else {
        let name = this.$refs.input.value
        let size = this.$refs.input.files && this.$refs.input.files[0].size
        if (!this.validateFile({name, size})) return
        newFiles = [{status: 'uploading', name}]
      }

      if (!newFiles.length) return

      if (this.isReplacing) {
        // type=image时，点击重新上传进入此分支，替换掉原位置的文件replacingFile
        let newFile = newFiles[0]
        if (this.requestMode === 'xhr' && window.URL) {
          newFile.src = window.URL.createObjectURL(newFile)
        }
        newFile.toBeUploaded = true

        this.$set(this.fileList, this.fileList.indexOf(this.replacingFile), newFile)
        this.replacingFile = null

        if (this.requestMode === 'iframe' && this.autoUpload) this.submit(newFile)
        if (this.requestMode === 'xhr' && this.autoUpload) this.upload(newFile)

        this.isReplacing = false
      } else {
        this.fileList = [
          ...this.fileList.filter(file => {
            return file.status !== 'failure'
          }),
          ...newFiles.map(file => {
            if (this.requestMode === 'xhr' && this.type === 'image' && window.URL) {
              file.src = window.URL.createObjectURL(file)
            }
            file.toBeUploaded = true
            return file
          })
        ]

        if (this.maxCount && this.fileList.length > this.maxCount) {
          this.fileList = this.fileList.slice(-this.maxCount)
        }

        if (this.requestMode === 'iframe' && this.autoUpload) this.submit()
        if (this.requestMode === 'xhr' && this.autoUpload) this.uploadFiles()
      }

      this.$emit('change', this.maxCount === 1 ? (this.fileList[0].src || this.fileList[0].name) : this.fileList)
      this.$refs.input.value = ''
    },
    validateFile (file) {
      let typeValidation = this.validateFileType(file.name)
      !typeValidation && this.$emit('invalid', '文件类型不符合要求！')

      let sizeValidation = this.validateFileSize(file.size)
      !sizeValidation && this.$emit('invalid', '文件大小超过限制！')

      return typeValidation && sizeValidation
    },
    validateFileType (filename) {
      if (!this.accept) return true

      let extension = filename.split('.')
      extension = extension[extension.length - 1].toLowerCase()

      return this.accept.split(/,\s*/).some(item => {
        let acceptExtention = item.split(/[./]/)[1].toLowerCase()

        if (acceptExtention === extension) return true

        if (acceptExtention === '*' && item.indexOf('/') > -1) {
          let targetExtensions = this.extensions[item.split('/')[0].toLowerCase()]
          if (targetExtensions && targetExtensions.hasOwnProperty(extension)) {
            return true
          }
        }
        return false
      })
    },
    validateFileSize (fileSize) {
      return !this.maxSize || fileSize <= bytes.parse(this.maxSize)
    },
    uploadFiles () {
      this.fileList.forEach(file => {
        if (file.toBeUploaded) this.upload(file)
      })
    },
    upload (file) {
      this.updateFileList(file, {status: 'uploading'})
      let xhr = new XMLHttpRequest()
      file.xhr = xhr

      xhr.upload.onprogress = e => {
        switch (this.progress) {
          case 'number':
          case 'bar':
            file.loaded = e.loaded
            file.total = e.total
            this.updateFileList(file)
            break
        }
        this.$emit('progress', e)
      }
      xhr.onload = () => {
        this.uploadCallback(this.parseData(xhr.responseText), file)
      }
      xhr.onerror = () => {
        this.onFailure({}, file)
        this.$emit('fail')
      }
      let formData = new FormData()
      formData.append(this.name, file)

      for (let key in this.payload) {
        formData.append(key, this.payload[key])
      }

      xhr.open('POST', this.queryURL, true)
      for (let key in this.headers) {
        xhr.setRequestHeader(key, this.headers[key])
      }
      xhr.withCredentials = this.withCredentials
      xhr.send(formData)
    },
    replaceFile (file) {
      this.replacingFile = file
    },
    submit (file = this.latestFile) {
      this.currentSubmitingFile = file
      this.updateFileList(file, {status: 'uploading'})

      this.isSubmiting = true

      this.$nextTick(() => {
        let form = this.$refs.form
        document.body.appendChild(this.$refs.iframe)
        document.body.appendChild(form)

        form.appendChild(this.$refs.input)
        form.submit()
        this.reset()
      })
    },
    uploadCallback (data, file) {
      this.isSubmiting = false

      this.convertResponse(data) || data
      if (data.status === 'success') {
        this.$emit('success', data)
        this.onSuccess(data, file)
      } else if (data.status === 'failure') {
        this.$emit('fail', data)
        this.onFailure(data, file)
      }
      this.currentSubmitingFile = null
    },
    onSuccess (data, file) {
      assign(file, data)
      file.status = 'success'
      file.xhr = null
      file.toBeUploaded = null
      this.updateFileList(file)
    },
    onFailure (data, file) {
      file.status = 'failure'
      file.xhr = null
      file.toBeUploaded = null
      file.failureReason = data.reason || ''
      this.updateFileList(file)
    },
    updateFileList (file, options) {
      if (options) assign(file, options)
      this.$set(this.fileList, this.fileList.indexOf(file), file)
      this.$emit('change', this.maxCount === 1 ? (this.fileList[0].src || this.fileList[0].name) : this.fileList)
    },
    retry (file) {
      if (this.requestMode === 'iframe') this.submit(file)
      else this.upload(file)
    },
    removeFile (file) {
      if (this.maxCount === 1) {
        this.fileList = []
        this.$emit('change', '')
      } else {
        this.fileList.splice(this.fileList.indexOf(file), 1)
        this.$emit('change', this.fileList)
      }

      this.$emit('remove', file)
    },
    cancelFile (file) {
      if (this.requestMode === 'iframe') {
        this.canceled = true
        this.isSubmiting = false
      }

      if (file.xhr) file.xhr.abort()

      this.removeFile(file)
    },
    reset () {
      this.$refs.input.value = ''
      this.$refs.label.appendChild(this.$refs.input)
    },
    convertSizeUnit (size) {
      return bytes(size, {decimalPlaces: 1})
    },
    parseData (data) {
      if (typeof data === 'object') return data
      if (typeof data === 'string') {
        try {
          return JSON.parse(data)
        } catch (error) {
          this.$emit('fail', {error})
        }
      }
    }
  }
}

function getProgress () {
  return {
    props: ['loaded', 'total', 'type', 'uploadingText', 'convertSizeUnit'],
    computed: {
      percent () {
        if (this.type !== 'text' && isNumber(this.loaded) && isNumber(this.total)) {
          return Math.ceil((this.loaded) / this.total * 100) + '%'
        }
        return ''
      },
      content () {
        switch (this.type) {
          case 'text':
            return this.$slots.default
          case 'number':
            return this.percent
              ? `${this.percent} ${this.convertSizeUnit(this.loaded)}/${this.convertSizeUnit(this.total)}`
              : ''
          case 'bar':
            return ''
        }
      }
    },
    render () {
      let bar = this.type === 'bar'
        ? [<div class="veui-uploader-progress-bar" style={{ width: this.percent || '0%' }}></div>,
          <div class="veui-uploader-progress-bar-full"></div>]
        : ''
      return (
        <div class="veui-uploader-progress">
          { this.content }
          { bar }
        </div>
      )
    }
  }
}
</script>
